<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Titan OS - Ultimate Control Panel">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <title>Titan OS | Command Center</title>

    <!-- مكتبات الخطوط والأيقونات -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;500;700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        /* ============================================================
           1. TITAN GLASS DESIGN SYSTEM (IPHONE STYLE)
           ============================================================ */
        :root {
            --bg-deep: #000000;
            --glass-material: rgba(28, 28, 30, 0.65);
            --glass-border: rgba(255, 255, 255, 0.12);
            --glass-highlight: rgba(255, 255, 255, 0.05);
            
            /* ألوان النيون المتقدمة */
            --accent-blue: #0A84FF;
            --accent-purple: #BF5AF2;
            --accent-green: #30D158;
            --accent-red: #FF453A;
            --accent-orange: #FF9F0A;
            
            --text-primary: #FFFFFF;
            --text-secondary: #8E8E93;
            
            --radius-xl: 28px;
            --radius-lg: 18px;
            --radius-sm: 10px;
            
            --blur-strength: 25px;
            --transition: cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            outline: none;
            user-select: none;
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-deep);
            color: var(--text-primary);
            font-family: 'Cairo', sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* خلفية النجوم المتحركة */
        #cosmos-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; pointer-events: none;
        }

        /* الحاوية الرئيسية (شاشة التطبيق) */
        .app-container {
            position: relative; z-index: 10;
            width: 95%; height: 92%;
            max-width: 1600px;
            display: flex; gap: 20px;
            transition: 0.3s;
        }

        /* ============================================================
           2. SIDEBAR (القائمة الجانبية الزجاجية)
           ============================================================ */
        .glass-panel {
            background: var(--glass-material);
            backdrop-filter: blur(var(--blur-strength));
            -webkit-backdrop-filter: blur(var(--blur-strength));
            border: 1px solid var(--glass-border);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            border-radius: var(--radius-xl);
        }

        .sidebar {
            width: 320px;
            display: flex; flex-direction: column;
            padding: 24px;
            flex-shrink: 0;
            transition: transform 0.4s var(--transition);
        }

        .brand-header {
            text-align: center; margin-bottom: 30px;
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 20px;
        }
        .brand-logo {
            font-family: 'Rajdhani', sans-serif;
            font-size: 2rem; font-weight: 700; letter-spacing: 2px;
            background: linear-gradient(135deg, #fff 0%, var(--accent-blue) 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .brand-sub { font-size: 0.7rem; letter-spacing: 4px; color: var(--text-secondary); opacity: 0.8; }

        .nav-menu { flex: 1; display: flex; flex-direction: column; gap: 12px; overflow-y: auto; }
        
        .nav-btn {
            display: flex; align-items: center; gap: 16px;
            padding: 16px 20px;
            border-radius: var(--radius-lg);
            color: var(--text-secondary);
            font-size: 1rem; font-weight: 600;
            cursor: pointer; transition: all 0.3s var(--transition);
            background: transparent; border: none;
            text-align: right;
        }
        .nav-btn:hover { background: var(--glass-highlight); color: #fff; transform: translateX(-5px); }
        .nav-btn.active {
            background: rgba(10, 132, 255, 0.15);
            color: var(--accent-blue);
            box-shadow: 0 0 20px rgba(10, 132, 255, 0.1);
        }
        .nav-btn i { width: 24px; text-align: center; font-size: 1.2rem; }

        /* قائمة المجموعات النشطة المصغرة */
        .active-groups-mini {
            margin-top: 20px; padding-top: 20px;
            border-top: 1px solid var(--glass-border);
            max-height: 200px; overflow-y: auto;
        }
        .mini-group-item {
            display: flex; align-items: center; gap: 10px;
            padding: 10px; border-radius: var(--radius-sm);
            cursor: pointer; transition: 0.2s;
        }
        .mini-group-item:hover { background: rgba(255,255,255,0.05); }
        .mini-group-item.selected { border: 1px solid var(--accent-green); background: rgba(48, 209, 88, 0.05); }
        .pulse-dot { width: 8px; height: 8px; background: var(--accent-green); border-radius: 50%; box-shadow: 0 0 8px var(--accent-green); }

        /* ============================================================
           3. MAIN STAGE (منطقة التحكم الرئيسية)
           ============================================================ */
        .main-stage {
            flex: 1;
            display: flex; flex-direction: column; gap: 20px;
            overflow-y: auto; overflow-x: hidden;
            border-radius: var(--radius-xl);
            padding-right: 5px; /* Scrollbar padding */
        }

        /* Header Bar */
        .top-bar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 25px;
            min-height: 80px;
        }
        .focus-toggle {
            display: flex; align-items: center; gap: 10px;
            background: rgba(0,0,0,0.3); padding: 8px 16px; border-radius: 30px;
            border: 1px solid var(--glass-border); cursor: pointer; transition: 0.3s;
        }
        .focus-toggle.active { border-color: var(--accent-orange); color: var(--accent-orange); box-shadow: 0 0 15px rgba(255, 159, 10, 0.2); }
        
        .user-pill {
            display: flex; align-items: center; gap: 12px;
            background: var(--glass-material); padding: 8px 12px 8px 20px;
            border-radius: 40px; border: 1px solid var(--glass-border);
        }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--accent-blue); }

        /* ============================================================
           4. VIDEO PLAYER (المشغل السينمائي)
           ============================================================ */
        .cinema-card {
            position: relative; overflow: hidden;
            width: 100%; aspect-ratio: 16/9;
            background: #000;
            border-radius: var(--radius-xl);
            border: 1px solid var(--glass-border);
            box-shadow: 0 30px 60px rgba(0,0,0,0.8);
            group-isolate: true;
        }
        video#stream-player { width: 100%; height: 100%; object-fit: contain; }
        
        /* طبقة التحكم فوق الفيديو */
        .player-hud {
            position: absolute; inset: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.95), transparent 60%);
            display: flex; flex-direction: column; justify-content: flex-end;
            padding: 30px; opacity: 0; transition: opacity 0.4s ease;
        }
        .cinema-card:hover .player-hud { opacity: 1; }

        .track-info { margin-bottom: 20px; transform: translateY(10px); transition: 0.4s; }
        .cinema-card:hover .track-info { transform: translateY(0); }
        .track-title { font-size: 1.8rem; font-weight: 800; margin: 0; text-shadow: 0 5px 15px rgba(0,0,0,1); }
        .track-artist { font-size: 1.1rem; color: #ccc; margin-top: 5px; }

        /* أزرار التحكم الزجاجية */
        .controls-row { display: flex; align-items: center; gap: 20px; justify-content: center; }
        .glass-btn {
            width: 55px; height: 55px; border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1); color: #fff;
            backdrop-filter: blur(10px);
            cursor: pointer; transition: 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex; align-items: center; justify-content: center; font-size: 1.3rem;
        }
        .glass-btn:hover { background: rgba(255,255,255,0.25); transform: scale(1.15); border-color: #fff; }
        .glass-btn:active { transform: scale(0.95); }
        
        .play-btn-lg {
            width: 75px; height: 75px; font-size: 2rem;
            background: var(--accent-blue); border: none;
            box-shadow: 0 0 30px var(--accent-blue);
        }
        .play-btn-lg:hover { background: #2997ff; box-shadow: 0 0 50px var(--accent-blue); }

        /* شريط التقدم */
        .seek-wrapper {
            width: 100%; display: flex; align-items: center; gap: 15px;
            margin-bottom: 15px; font-family: monospace; font-size: 0.9rem;
        }
        input[type=range] {
            flex: 1; -webkit-appearance: none; background: rgba(255,255,255,0.2);
            height: 4px; border-radius: 2px; cursor: pointer;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 14px; height: 14px; background: #fff;
            border-radius: 50%; box-shadow: 0 0 10px rgba(255,255,255,0.5);
            transition: 0.2s;
        }
        input[type=range]:hover::-webkit-slider-thumb { transform: scale(1.3); }

        /* ============================================================
           5. DASHBOARD WIDGETS (الإحصائيات والأدوات)
           ============================================================ */
        .grid-2 { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        .widget-card { padding: 25px; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        
        .stat-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 10px; }
        .stat-item {
            background: rgba(255,255,255,0.03); padding: 15px; border-radius: var(--radius-lg);
            text-align: center; border: 1px solid rgba(255,255,255,0.05);
        }
        .stat-num { font-size: 1.6rem; font-weight: 800; font-family: 'Rajdhani'; color: var(--accent-blue); }

        /* Inputs & Actions */
        .neon-input {
            width: 100%; background: rgba(0,0,0,0.4); border: 1px solid var(--glass-border);
            padding: 15px 20px; border-radius: var(--radius-lg); color: #fff; font-family: inherit;
            margin-bottom: 15px; transition: 0.3s;
        }
        .neon-input:focus { border-color: var(--accent-blue); box-shadow: 0 0 15px rgba(10, 132, 255, 0.2); }

        .action-btn {
            width: 100%; padding: 15px; border-radius: var(--radius-lg); border: none;
            background: var(--glass-highlight); color: #fff; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: 0.3s; margin-bottom: 10px;
        }
        .action-btn:hover { background: rgba(255,255,255,0.1); transform: translateY(-2px); }
        .btn-blue { background: var(--accent-blue); box-shadow: 0 5px 20px rgba(10, 132, 255, 0.3); }
        .btn-blue:hover { background: #2997ff; }
        .btn-danger { background: rgba(255, 69, 58, 0.2); color: var(--accent-red); border: 1px solid rgba(255,69,58,0.3); }
        .btn-danger:hover { background: var(--accent-red); color: white; }

        /* Modal Overlay */
        .modal-wrap {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(15px);
            z-index: 100; display: none; align-items: center; justify-content: center;
        }
        .modal-wrap.active { display: flex; animation: fadeScale 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .glass-modal { width: 90%; max-width: 500px; padding: 40px; }

        @keyframes fadeScale { from{opacity:0; transform:scale(0.9);} to{opacity:1; transform:scale(1);} }

        /* Responsive */
        @media (max-width: 1100px) {
            .app-container { flex-direction: column; width: 100%; height: 100%; border-radius: 0; }
            .sidebar { 
                position: fixed; right: -100%; top: 0; height: 100%; z-index: 50; 
                width: 280px; box-shadow: -10px 0 50px rgba(0,0,0,0.8);
            }
            .sidebar.active { right: 0; }
            .grid-2 { grid-template-columns: 1fr; }
            .mobile-menu-btn { display: block !important; }
        }
        .mobile-menu-btn { display: none; font-size: 1.5rem; background:none; border:none; color:#fff; }
        .hidden-section { display: none; }

    </style>
</head>
<body>

    <!-- محرك الخلفية (نجوم متحركة) -->
    <canvas id="cosmos-canvas"></canvas>

    <!-- نافذة تشغيل ميديا (MODAL) -->
    <div class="modal-wrap" id="mediaModal">
        <div class="glass-panel glass-modal">
            <h2 style="margin-top:0"><i class="fa-brands fa-youtube" style="color:#FF0000"></i> تشغيل ميديا جديدة</h2>
            <p style="color:#aaa; margin-bottom:20px;">يمكنك لصق رابط يوتيوب أو كتابة اسم الأغنية للتشغيل في المجموعة المختارة.</p>
            
            <input type="text" id="mediaInput" class="neon-input" placeholder="مثال: سورة البقرة أو رابط مباشر..." autofocus>
            
            <div style="display:flex; gap:15px;">
                <button class="action-btn btn-blue" onclick="submitPlayReq()">
                    <i class="fa-solid fa-play"></i> تشغيل الآن
                </button>
                <button class="action-btn" onclick="toggleModal('mediaModal')" style="width:120px;">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- الحاوية الرئيسية للتطبيق -->
    <div class="app-container">

        <!-- القائمة الجانبية -->
        <aside class="glass-panel sidebar" id="mainSidebar">
            <div class="brand-header">
                <div class="brand-logo">TITAN OS</div>
                <div class="brand-sub">ULTIMATE KERNEL v4.5</div>
            </div>

            <nav class="nav-menu">
                <button class="nav-btn active" onclick="switchView('dashboard', this)">
                    <i class="fa-solid fa-layer-group"></i> لوحة التحكم
                </button>
                <button class="nav-btn" onclick="switchView('security', this)">
                    <i class="fa-solid fa-shield-cat"></i> نظام الحماية
                </button>
                <button class="nav-btn" onclick="switchView('settings', this)">
                    <i class="fa-solid fa-server"></i> السيرفر
                </button>
            </nav>

            <div style="margin-top:20px;">
                <div style="display:flex; justify-content:space-between; color:var(--text-secondary); font-size:0.8rem; margin-bottom:10px;">
                    <span>المجموعات المتصلة</span>
                    <i class="fa-solid fa-rotate" style="cursor:pointer" onclick="updateCallsList()"></i>
                </div>
                <div class="active-groups-mini" id="groupsList">
                    <!-- سيتم تعبئة القائمة هنا -->
                    <div style="text-align:center; padding:20px; color:#555;">جاري البحث...</div>
                </div>
            </div>

            <button class="action-btn btn-danger" onclick="window.location.href='/logout'" style="margin-top:auto">
                <i class="fa-solid fa-power-off"></i> تسجيل خروج
            </button>
        </aside>

        <!-- المسرح الرئيسي -->
        <main class="glass-panel main-stage">
            
            <!-- الشريط العلوي -->
            <header class="top-bar glass-panel" style="border-radius: var(--radius-lg); margin: 20px 20px 0 20px;">
                <button class="mobile-menu-btn" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
                
                <div class="focus-toggle" id="focusBtn" onclick="toggleFocusMode()">
                    <i class="fa-solid fa-eye"></i> <span>وضع التركيز (Server Focus)</span>
                </div>

                <div class="user-pill">
                    <div style="text-align:left;">
                        <div style="font-weight:bold; font-size:0.9rem;">Root Admin</div>
                        <div style="font-size:0.7rem; color:var(--accent-green);">Online <span id="ping-badge">--ms</span></div>
                    </div>
                    <img src="https://ui-avatars.com/api/?name=Admin&background=0A84FF&color=fff" class="user-avatar">
                </div>
            </header>

            <div style="padding: 20px;">
                
                <!-- [VIEW 1] DASHBOARD -->
                <div id="view-dashboard" class="view-section">
                    <div class="grid-2">
                        <!-- عمود المشغل -->
                        <div style="display:flex; flex-direction:column; gap:20px;">
                            
                            <!-- كارت الفيديو السينمائي -->
                            <div class="cinema-card">
                                <video id="stream-player" playsinline poster="https://telegra.ph/file/5eb6df308e92f4477813d.jpg"></video>
                                <div class="player-hud">
                                    <div class="track-info">
                                        <h2 class="track-title" id="track-title">System Idle</h2>
                                        <div class="track-artist" id="track-artist">Select a group to start monitoring</div>
                                    </div>
                                    
                                    <!-- شريط الوقت (للعرض فقط لأن البث مباشر) -->
                                    <div class="seek-wrapper">
                                        <span id="curr-time">00:00</span>
                                        <input type="range" value="0" min="0" max="100" id="seek-bar" onchange="seekLocal(this.value)">
                                        <span id="dur-time">LIVE</span>
                                    </div>

                                    <!-- أزرار التحكم -->
                                    <div class="controls-row">
                                        <button class="glass-btn" title="Seek Back 10s" onclick="playerCmd('seek_back')"><i class="fa-solid fa-rotate-left"></i></button>
                                        <button class="glass-btn" title="Pause" onclick="playerCmd('pause')"><i class="fa-solid fa-pause"></i></button>
                                        
                                        <button class="glass-btn play-btn-lg" id="play-pause-btn" onclick="togglePlayLocal()">
                                            <i class="fa-solid fa-play"></i>
                                        </button>
                                        
                                        <button class="glass-btn" title="Next" onclick="playerCmd('skip')"><i class="fa-solid fa-forward-step"></i></button>
                                        <button class="glass-btn" title="Seek Fwd 10s" onclick="playerCmd('seek_fwd')"><i class="fa-solid fa-rotate-right"></i></button>
                                        
                                        <div style="width:20px;"></div> <!-- فاصل -->
                                        
                                        <button class="glass-btn" onclick="toggleMute()"><i class="fa-solid fa-volume-high" id="vol-icon"></i></button>
                                        <button class="glass-btn" onclick="toggleFullscreen()"><i class="fa-solid fa-expand"></i></button>
                                    </div>
                                </div>
                            </div>

                            <!-- الإحصائيات الحية -->
                            <div class="widget-card glass-panel" style="border-radius: var(--radius-lg);">
                                <h3 style="margin:0; color:var(--text-secondary)">مراقبة الموارد (Live Resources)</h3>
                                <div class="stat-row">
                                    <div class="stat-item">
                                        <div class="stat-num" id="cpu-val">0%</div>
                                        <div style="font-size:0.8rem">CPU Load</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-num" id="ram-val">0%</div>
                                        <div style="font-size:0.8rem">RAM Usage</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-num" id="ping-val">0ms</div>
                                        <div style="font-size:0.8rem">Telegram Ping</div>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <!-- عمود التحكم الجانبي -->
                        <div style="display:flex; flex-direction:column; gap:20px;">
                            
                            <div class="widget-card glass-panel" style="border-radius: var(--radius-lg);">
                                <h3 style="margin-bottom:15px; display:flex; align-items:center; gap:10px;">
                                    <i class="fa-solid fa-gamepad" style="color:var(--accent-purple)"></i> تحكم سريع
                                </h3>
                                
                                <button class="action-btn" onclick="toggleModal('mediaModal')">
                                    <i class="fa-brands fa-youtube" style="color:#f00"></i> تشغيل من الرابط/بحث
                                </button>
                                <button class="action-btn" onclick="playerCmd('resume')">
                                    <i class="fa-solid fa-play"></i> استئناف البث (Resume)
                                </button>
                                <button class="action-btn" onclick="playerCmd('loop')">
                                    <i class="fa-solid fa-repeat"></i> تكرار (Loop)
                                </button>
                                <button class="action-btn btn-danger" onclick="playerCmd('stop')">
                                    <i class="fa-solid fa-stop"></i> إيقاف وتفريغ الطابور
                                </button>
                            </div>

                            <div class="widget-card glass-panel" style="flex:1; border-radius: var(--radius-lg);">
                                <h3 style="margin-bottom:10px;">السجل المصغر</h3>
                                <div id="mini-log" style="font-family:monospace; font-size:0.8rem; color:var(--accent-green); opacity:0.8; overflow:hidden;">
                                    > System Ready...<br>
                                    > Waiting for commands...
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- [VIEW 2] SECURITY -->
                <div id="view-security" class="view-section hidden-section">
                    <div class="widget-card glass-panel" style="border-radius: var(--radius-lg);">
                        <h2><i class="fa-solid fa-user-shield"></i> الحظر العام (GBAN System)</h2>
                        <p style="color:var(--text-secondary)">حظر مستخدم نهائياً من استخدام البوت في جميع المجموعات.</p>
                        
                        <div style="margin-top:20px; max-width:500px;">
                            <input type="number" id="sec-uid" class="neon-input" placeholder="Telegram User ID (Ex: 123456789)">
                            <div style="display:flex; gap:10px;">
                                <button class="action-btn btn-danger" onclick="securityAct('block')">حظر المستخدم</button>
                                <button class="action-btn" onclick="securityAct('unblock')">رفع الحظر</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- [VIEW 3] SETTINGS -->
                <div id="view-settings" class="view-section hidden-section">
                    <div class="widget-card glass-panel" style="border-radius: var(--radius-lg);">
                        <h2><i class="fa-solid fa-gears"></i> صيانة السيرفر (Server Ops)</h2>
                        
                        <div class="grid-2" style="margin-top:20px;">
                            <button class="action-btn" onclick="sysAct('clean')">
                                <i class="fa-solid fa-broom"></i> تنظيف الكاش (Turbo Clean)
                            </button>
                            <button class="action-btn" onclick="sysAct('update')">
                                <i class="fa-brands fa-git-alt"></i> تحديث السورس (Git Pull)
                            </button>
                            <button class="action-btn btn-danger" onclick="sysAct('restart')">
                                <i class="fa-solid fa-power-off"></i> إعادة تشغيل البوت (Reboot)
                            </button>
                            <a href="/api/logs" target="_blank" class="action-btn" style="text-decoration:none;">
                                <i class="fa-solid fa-file-code"></i> تحميل السجلات (Logs)
                            </a>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>
    <!-- سكربت المحرك (TITAN KERNEL JS) -->
    <script>
        const API_BASE = '/api';
        let currentChatId = localStorage.getItem('titan_chat_id'); // حفظ الجروب المختار
        let focusMode = false;
        let statsInterval = null;

        // 1. تهيئة النظام عند التحميل
        document.addEventListener('DOMContentLoaded', () => {
            initCosmos();
            updateCallsList();
            startMonitoring();
            
            // استعادة الجروب الأخير
            if(currentChatId) {
                log(`Resumed session for Chat: ${currentChatId}`);
            }
        });

        // 2. محرك الخلفية (Cosmos Engine) - أنيميشن النجوم
        const canvas = document.getElementById('cosmos-canvas');
        const ctx = canvas.getContext('2d');
        let stars = [];

        function initCosmos() {
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // إنشاء 100 نجمة
            for(let i=0; i<100; i++) stars.push(createStar());
            animateCosmos();
        }

        function createStar() {
            return {
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                size: Math.random() * 2,
                speed: Math.random() * 0.5,
                alpha: Math.random()
            };
        }

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        function animateCosmos() {
            if(focusMode) return; // توفير الموارد في وضع التركيز
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#FFF';
            
            stars.forEach(star => {
                star.y -= star.speed;
                if(star.y < 0) star.y = canvas.height;
                
                ctx.globalAlpha = star.alpha;
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.size, 0, Math.PI*2);
                ctx.fill();
            });
            requestAnimationFrame(animateCosmos);
        }

        // 3. وظائف النظام الأساسية
        function toggleSidebar() {
            document.getElementById('mainSidebar').classList.toggle('active');
        }

        function switchView(viewId, btn) {
            // إخفاء الكل وإظهار المطلوب
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden-section'));
            document.getElementById('view-' + viewId).classList.remove('hidden-section');
            
            // تحديث الأزرار
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            if(btn) btn.classList.add('active');
            
            // إغلاق القائمة في الموبايل
            if(window.innerWidth < 1100) document.getElementById('mainSidebar').classList.remove('active');
        }

        function toggleFocusMode() {
            focusMode = !focusMode;
            const btn = document.getElementById('focusBtn');
            if(focusMode) {
                btn.classList.add('active');
                ctx.clearRect(0, 0, canvas.width, canvas.height); // مسح الخلفية
                log("Server Focus Mode: ON (Animation Stopped)");
            } else {
                btn.classList.remove('active');
                animateCosmos();
                log("Server Focus Mode: OFF");
            }
        }

        function log(msg) {
            const el = document.getElementById('mini-log');
            el.innerHTML = `> ${msg}<br>${el.innerHTML}`;
        }

        // 4. الاتصال بالبايثون (API Calls)
        async function updateCallsList() {
            const list = document.getElementById('groupsList');
            list.innerHTML = '<div style="text-align:center; padding:10px;"><i class="fa-solid fa-circle-notch fa-spin"></i></div>';
            
            try {
                const res = await fetch(`${API_BASE}/player/active_calls`);
                const data = await res.json();
                
                list.innerHTML = '';
                if(!data.chats || data.chats.length === 0) {
                    list.innerHTML = '<div style="text-align:center; color:#666; font-size:0.9rem;">لا توجد مكالمات نشطة</div>';
                    return;
                }

                data.chats.forEach(chat => {
                    const isSelected = currentChatId == chat.chat_id ? 'selected' : '';
                    const html = `
                    <div class="mini-group-item ${isSelected}" onclick="selectChat('${chat.chat_id}', '${chat.name}')">
                        <div class="pulse-dot"></div>
                        <div style="overflow:hidden;">
                            <div style="font-weight:bold; font-size:0.9rem; white-space:nowrap;">${chat.name}</div>
                            <div style="font-size:0.7rem; color:#888;">ID: ${chat.chat_id}</div>
                        </div>
                    </div>`;
                    list.innerHTML += html;
                });

            } catch(e) { console.error(e); }
        }

        function selectChat(id, name) {
            currentChatId = id;
            localStorage.setItem('titan_chat_id', id);
            log(`Connected to Group: ${name}`);
            updateCallsList(); // لتحديث التظليل
            refreshPlayer(); // تحديث المشغل فوراً
        }

        // 5. التحكم في المشغل
        function refreshPlayer() {
            if(!currentChatId) return;
            
            // تحديث مصدر الفيديو مع إضافة timestamp لمنع الكاش
            const player = document.getElementById('stream-player');
            const newSrc = `/stream/live/${currentChatId}?t=${Date.now()}`;
            
            // التحديث فقط إذا تغير المصدر
            if(!player.src.includes(currentChatId)) {
                player.src = newSrc;
                player.load();
                // محاولة التشغيل التلقائي (قد تمنعها المتصفحات)
                player.play().catch(e => console.log("Autoplay blocked"));
            }
            
            fetchTrackInfo();
        }

        async function fetchTrackInfo() {
            if(!currentChatId) return;
            try {
                const res = await fetch(`${API_BASE}/player/track_info/${currentChatId}`);
                const data = await res.json();
                
                document.getElementById('track-title').innerText = data.title || "Unknown";
                document.getElementById('track-artist').innerText = data.artist || "Unknown";
                
                // تحديث زر التشغيل بناءً على حالة البوت
                const icon = document.getElementById('play-pause-btn').querySelector('i');
                icon.className = data.is_playing ? 'fa-solid fa-pause' : 'fa-solid fa-play';

            } catch(e) {}
        }

        async function playerCmd(cmd) {
            if(!currentChatId) return alert("الرجاء اختيار مجموعة من القائمة الجانبية أولاً!");
            
            // التعامل مع التقديم والتأخير محلياً للمشغل (للمعاينة)
            const player = document.getElementById('stream-player');
            if (cmd === 'seek_fwd') { player.currentTime += 10; return; }
            if (cmd === 'seek_back') { player.currentTime -= 10; return; }

            // إرسال الأمر للبوت (Pause, Resume, Skip, Stop)
            const formData = new FormData();
            formData.append('cmd', cmd);
            formData.append('chat_id', currentChatId);

            try {
                const res = await fetch(`${API_BASE}/player/control`, { method:'POST', body: formData });
                const json = await res.json();
                
                if(json.status === 'Success') {
                    log(`Command Executed: ${cmd}`);
                    setTimeout(fetchTrackInfo, 1000); // تحديث المعلومات
                } else {
                    log(`Error: ${json.error}`);
                }
            } catch(e) { log("Connection Error"); }
        }

        // تشغيل ميديا جديدة (بحث/رابط)
        function toggleModal(id) {
            document.getElementById(id).classList.toggle('active');
        }

        async function submitPlayReq() {
            const query = document.getElementById('mediaInput').value;
            if(!query || !currentChatId) return alert("أدخل الرابط واختر المجموعة!");
            
            toggleModal('mediaModal');
            log("Sending Play Request...");
            
            try {
                const res = await fetch(`${API_BASE}/player/play`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ chat_id: currentChatId, query: query })
                });
                const json = await res.json();
                if(json.status === 'Success') log(`Playing: ${json.title}`);
                else log(`Error: ${json.error}`);
            } catch(e) { log("Failed to send request"); }
        }

        // 6. المراقبة الدورية (Stats Loop)
        function startMonitoring() {
            if(statsInterval) clearInterval(statsInterval);
            statsInterval = setInterval(async () => {
                // جلب إحصائيات السيرفر
                try {
                    const res = await fetch(`${API_BASE}/system/status`);
                    const d = await res.json();
                    document.getElementById('cpu-val').innerText = d.cpu + '%';
                    document.getElementById('ram-val').innerText = d.ram + '%';
                    document.getElementById('ping-val').innerText = d.ping + 'ms';
                    document.getElementById('ping-badge').innerText = d.ping + 'ms';
                } catch(e) {}

                // تحديث معلومات التراك إذا كان هناك جروب مختار
                if(currentChatId) fetchTrackInfo();
            }, 3000);
        }

        // أدوات مساعدة
        function togglePlayLocal() {
            const p = document.getElementById('stream-player');
            if(p.paused) { p.play(); playerCmd('resume'); }
            else { p.pause(); playerCmd('pause'); }
        }
        function toggleMute() {
            const p = document.getElementById('stream-player');
            p.muted = !p.muted;
            document.getElementById('vol-icon').className = p.muted ? 'fa-solid fa-volume-xmark' : 'fa-solid fa-volume-high';
        }
        function toggleFullscreen() {
            const el = document.querySelector('.cinema-card');
            if(!document.fullscreenElement) el.requestFullscreen();
            else document.exitFullscreen();
        }
        function seekLocal(val) {
            // شريط وهمي للمشاهدة
            const p = document.getElementById('stream-player');
            // هذا يحتاج حساب المدة، سنتركه للعرض حالياً
        }

        // أوامر النظام والأمان
        async function sysAct(action) {
            if(action === 'restart' && !confirm("هل أنت متأكد من إعادة تشغيل البوت؟")) return;
            await fetch(`${API_BASE}/system/action`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: action })
            });
            log(`System Action: ${action}`);
        }

        async function securityAct(type) {
            const uid = document.getElementById('sec-uid').value;
            if(!uid) return alert("أدخل الآيدي!");
            
            await fetch(`${API_BASE}/security/block`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ user_id: uid, block: (type === 'block') })
            });
            log(`User ${type}ed: ${uid}`);
        }

    </script>
</body>
</html>
